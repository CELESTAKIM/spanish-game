<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Livability Index</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
        :root {
            --green: #2ecc71;
            --yellow: #f1c40f;
            --dark: #1a1a1a;
            --card: #2c2c2c;
            --text: #ecf0f1;
            --border: #444;
            --shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--dark);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* Floating Panel Base */
        .panel {
            position: absolute;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 100;
            min-width: 300px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .panel.minimized {
            height: 50px !important;
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--green), #27ae60);
            color: white;
            padding: 0.8rem 1rem;
            border-radius: 11px 11px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .panel-controls button {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 4px;
            transition: 0.2s;
        }

        .panel-controls button:hover {
            background: rgba(255,255,255,0.2);
        }

        .panel-body {
            padding: 1rem;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Resize Handle */
        .resize-handle {
            position: absolute;
            bottom: 0; right: 0;
            width: 16px; height: 16px;
            cursor: se-resize;
            background: linear-gradient(-45deg, transparent 50%, var(--green) 50%);
        }

        /* Map Panel */
        #mapPanel {
            top: 20px; left: 20px;
            width: calc(100% - 40px);
            height: calc(100vh - 40px);
            z-index: 50;
        }

        #map { height: 100%; border-radius: 0 0 11px 11px; }

        /* Floating Action Button */
        #fab {
            position: fixed;
            bottom: 20px; right: 20px;
            background: var(--green);
            color: white;
            width: 60px; height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            transition: 0.3s;
        }

        #fab:hover { transform: scale(1.1); }

        /* Mini Menu */
        #miniMenu {
            position: fixed;
            bottom: 90px; right: 20px;
            background: var(--card);
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 999;
        }

        .menu-btn {
            background: #333;
            color: var(--text);
            border: none;
            padding: 0.7rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: 0.2s;
        }

        .menu-btn:hover {
            background: var(--green);
            color: white;
        }

        /* Chart Panel */
        .chart-container {
            background: #333;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .chart-title {
            color: var(--yellow);
            margin-bottom: 0.8rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Basemap Selector */
        #basemapPanel {
            top: 20px; right: 20px;
            width: 220px;
            z-index: 200;
        }

        .basemap-item {
            padding: 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: 0.2s;
        }

        .basemap-item:hover, .basemap-item.active {
            background: var(--green);
            color: white;
        }

        .basemap-thumb {
            width: 36px; height: 36px;
            border-radius: 4px;
            background: #555;
            background-size: cover;
        }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: #333;
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--green);
        }

        .stat-card h3 {
            color: var(--yellow);
            font-size: 1.5rem;
        }

        /* Filters Panel */
        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            margin: 0.4rem 0;
            font-size: 0.9rem;
        }

        /* Signal Line */
        .signal-line {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem;
            background: #333;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-top: 0.8rem;
        }

        .trend-up { color: #27ae60; }
        .trend-down { color: #e74c3c; }

        /* Popup */
        .leaflet-popup-content-wrapper {
            background: var(--card) !important;
            color: var(--text) !important;
            border-radius: 10px !important;
        }

        .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            font-size: 0.9rem;
        }

        .popup-label { color: var(--yellow); font-weight: 600; }

        /* Responsive */
        @media (max-width: 768px) {
            .panel { width: 90% !important; left: 5% !important; }
            #mapPanel { height: 60vh; top: 10px; }
        }
    </style>
</head>
<body>

    <!-- Floating Action Button -->
    <div id="fab">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Mini Menu -->
    <div id="miniMenu">
        <button class="menu-btn" data-panel="statsPanel"><i class="fas fa-chart-bar"></i> Stats</button>
        <button class="menu-btn" data-panel="filtersPanel"><i class="fas fa-filter"></i> Filters</button>
        <button class="menu-btn" data-panel="analysisPanel"><i class="fas fa-chart-line"></i> Analysis</button>
        <button class="menu-btn" data-panel="basemapPanel"><i class="fas fa-layer-group"></i> Basemaps</button>
    </div>

    <!-- Map Panel (Always Visible) -->
    <div id="mapPanel" class="panel">
        <div class="panel-header">
            <span><i class="fas fa-map"></i> Livability Index Map</span>
            <div class="panel-controls">
                <button class="minimize-btn"><i class="fas fa-window-minimize"></i></button>
            </div>
        </div>
        <div id="map"></div>
        <div class="resize-handle"></div>
    </div>

    <!-- Stats Panel -->
    <div id="statsPanel" class="panel" style="display:none; top:60px; left:20px; width:340px;">
        <div class="panel-header">
            <span><i class="fas fa-tachometer-alt"></i> Key Statistics</span>
            <div class="panel-controls">
                <button class="minimize-btn"><i class="fas fa-window-minimize"></i></button>
                <button class="close-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="panel-body">
            <div class="stats-grid">
                <div class="stat-card"><h3>1,247</h3><p>Projects</p></div>
                <div class="stat-card"><h3>47</h3><p>Counties</p></div>
                <div class="stat-card"><h3>$2.8B</h3><p>Value</p></div>
                <div class="stat-card"><h3>68.4</h3><p>Avg. Score</p></div>
            </div>
            <div class="chart-container">
                <div class="chart-title"><i class="fas fa-tasks"></i> Status</div>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- Filters Panel -->
    <div id="filtersPanel" class="panel" style="display:none; top:60px; left:380px; width:300px;">
        <div class="panel-header">
            <span><i class="fas fa-sliders-h"></i> Filters</span>
            <div class="panel-controls">
                <button class="minimize-btn"><i class="fas fa-window-minimize"></i></button>
                <button class="close-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="panel-body">
            <div class="filter-group">
                <strong>Counties</strong>
                <label><input type="checkbox" checked> Nairobi</label>
                <label><input type="checkbox" checked> Mombasa</label>
                <label><input type="checkbox"> Kisumu</label>
            </div>
            <div class="filter-group">
                <strong>Status</strong>
                <label><input type="checkbox" checked> Ongoing</label>
                <label><input type="checkbox" checked> Completed</label>
            </div>
            <button style="width:100%; padding:0.7rem; background:var(--green); color:white; border:none; border-radius:6px; margin-top:1rem;">
                Apply Filters
            </button>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- Analysis Panel -->
    <div id="analysisPanel" class="panel" style="display:none; top:60px; right:260px; width:500px;">
        <div class="panel-header">
            <span><i class="fas fa-analytics"></i> Data Analysis</span>
            <div class="panel-controls">
                <button class="minimize-btn"><i class="fas fa-window-minimize"></i></button>
                <button class="close-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="panel-body">
            <div class="chart-container">
                <div class="chart-title"><i class="fas fa-pie-chart"></i> Thematic Weighting</div>
                <canvas id="weightingChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title"><i class="fas fa-project-diagram"></i> Score vs Density</div>
                <canvas id="scatterChart"></canvas>
            </div>
            <div style="display:flex; gap:0.5rem;">
                <button style="flex:1; padding:0.6rem; background:#333; color:var(--text); border:1px solid var(--border); border-radius:6px;">
                    Export CSV
                </button>
                <button style="flex:1; padding:0.6rem; background:var(--yellow); color:#000; border:none; border-radius:6px;">
                    Export PDF
                </button>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- Basemap Panel -->
    <div id="basemapPanel" class="panel">
        <div class="panel-header">
            <span><i class="fas fa-layer-group"></i> Basemaps</span>
            <div class="panel-controls">
                <button class="minimize-btn"><i class="fas fa-window-minimize"></i></button>
                <button class="close-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="panel-body">
            <div class="basemap-item active" data-layer="dark">
                <div class="basemap-thumb" style="background-image:url('https://via.placeholder.com/36x36/333/666?text=D')"></div>
                <span>Dark Matter</span>
            </div>
            <div class="basemap-item" data-layer="satellite">
                <div class="basemap-thumb" style="background-image:url('https://via.placeholder.com/36x36/456/789?text=S')"></div>
                <span>Satellite</span>
            </div>
            <div class="basemap-item" data-layer="sentinel">
                <div class="basemap-thumb" style="background-image:url('https://via.placeholder.com/36x36/234/567?text=S2')"></div>
                <span>Sentinel-2</span>
            </div>
            <div class="basemap-item" data-layer="streets">
                <div class="basemap-thumb" style="background-image:url('https://via.placeholder.com/36x36/fff/000?text=ST')"></div>
                <span>Streets</span>
            </div>
            <div class="basemap-item" data-layer="terrain">
                <div class="basemap-thumb" style="background-image:url('https://via.placeholder.com/36x36/654/321?text=T')"></div>
                <span>Terrain</span>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // === Panel System ===
        const panels = {};
        let zIndex = 100;

        document.querySelectorAll('.panel').forEach(p => {
            const id = p.id;
            panels[id] = p;
            p.style.zIndex = zIndex++;

            // Make draggable
            const header = p.querySelector('.panel-header');
            let isDragging = false, startX, startY, startLeft, startTop;

            header.addEventListener('mousedown', e => {
                if (e.target.closest('button')) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = p.offsetLeft;
                startTop = p.offsetTop;
                p.style.zIndex = ++zIndex;
            });

            document.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                p.style.left = (startLeft + dx) + 'px';
                p.style.top = (startTop + dy) + 'px';
            });

            document.addEventListener('mouseup', () => { isDragging = false; });

            // Resize
            const resize = p.querySelector('.resize-handle');
            let resizing = false;
            resize.addEventListener('mousedown', e => {
                resizing = true;
                e.stopPropagation();
            });

            document.addEventListener('mousemove', e => {
                if (!resizing) return;
                const rect = p.getBoundingClientRect();
                p.style.width = (e.clientX - rect.left + 10) + 'px';
                p.style.height = (e.clientY - rect.top + 10) + 'px';
            });

            document.addEventListener('mouseup', () => { resizing = false; });

            // Controls
            p.querySelector('.minimize-btn')?.addEventListener('click', () => {
                p.classList.toggle('minimized');
            });

            p.querySelector('.close-btn')?.addEventListener('click', () => {
                p.style.display = 'none';
            });
        });

        // FAB Menu
        const fab = document.getElementById('fab');
        const menu = document.getElementById('miniMenu');
        fab.addEventListener('click', () => {
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
        });

        document.querySelectorAll('.menu-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const panelId = btn.dataset.panel;
                const panel = panels[panelId];
                panel.style.display = 'block';
                panel.style.zIndex = ++zIndex;
                menu.style.display = 'none';
            });
        });

        // === Map ===
        const map = L.map('map').setView([-1.2921, 36.8219], 6);
        const basemaps = {
            dark: L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png'),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            sentinel: L.tileLayer('https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless_3857/default/g/{z}/{y}/{x}.jpg'),
            streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
            terrain: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}')
        };
        basemaps.dark.addTo(map);

        document.querySelectorAll('.basemap-item').forEach(item => {
            item.addEventListener('click', () => {
                const layer = basemaps[item.dataset.layer];
                map.eachLayer(l => map.removeLayer(l));
                layer.addTo(map);
                document.querySelectorAll('.basemap-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });
        });

        // Markers
        const markers = L.markerClusterGroup();
        const projects = [
            {lat: -1.2921, lng: 36.8219, name: "Nairobi Water", status: "Ongoing", cost: "$45M", theme: "Water", impact: "+28%"},
            {lat: -4.0435, lng: 39.6682, name: "Mombasa Health", status: "Completed", cost: "$32M", theme: "Health", impact: "+42%"}
        ];

        projects.forEach(p => {
            const color = p.status === "Completed" ? "#27ae60" : "#f1c40f";
            const icon = L.divIcon({
                html: `<div style="background:${color}; width:14px; height:14px; border-radius:50%; border:3px solid white;"></div>`,
                iconSize: [20,20], className: 'custom-icon'
            });
            const marker = L.marker([p.lat, p.lng], {icon});
            const trend = p.impact.includes('+') ? 'trend-up' : 'trend-down';
            marker.bindPopup(`
                <b>${p.name}</b><br>
                <div class="popup-row"><span class="popup-label">Status:</span> ${p.status}</div>
                <div class="popup-row"><span class="popup-label">Cost:</span> ${p.cost}</div>
                <div class="popup-row"><span class="popup-label">Theme:</span> ${p.theme}</div>
                <div class="signal-line ${trend}">
                    <i class="fas fa-arrow-up"></i> Impact: <strong>${p.impact}</strong>
                </div>
            `);
            markers.addLayer(marker);
        });
        map.addLayer(markers);

        // === Charts ===
        new Chart(document.getElementById('statusChart'), {
            type: 'bar', data: {
                labels: ['Awarding', 'Ongoing', 'Completed'],
                datasets: [{ data: [89, 312, 428], backgroundColor: ['#3498db', '#f1c40f', '#27ae60'] }]
            }, options: { responsive: true, plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('weightingChart'), {
            type: 'doughnut', data: {
                labels: ['Health', 'Education', 'Water'], datasets: [{
                    data: [30, 25, 20], backgroundColor: ['#e74c3c', '#9b59b6', '#3498db']
                }]
            }, options: { responsive: true }
        });

        new Chart(document.getElementById('scatterChart'), {
            type: 'scatter', data: {
                datasets: [{
                    label: 'Counties', data: [
                        {x: 120, y: 78}, {x: 210, y: 82}, {x: 310, y: 88}
                    ], backgroundColor: 'rgba(46,204,113,0.8)'
                }]
            }, options: {
                scales: {
                    x: { title: { display: true, text: 'Density' } },
                    y: { title: { display: true, text: 'Score' }, min: 40, max: 100 }
                }
            }
        });

        // Fit map
        setTimeout(() => map.fitBounds(markers.getBounds().pad(0.2)), 500);
    </script>
</body>
</html>
